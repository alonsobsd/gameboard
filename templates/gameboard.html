<div id="gameboardPage" x-data="alpineGameboard()" x-init="initPage()">
    <div>
        <h2>Gameboard<sub class="is-size-7 pl-1">red vs. blue exercises</sub></h2>
        <p>
            Monitor red-and-blue team operations during an exercise to see if blue can detect, respond, and
            shut down a red-team adversary.
        </p>
    </div>
    <hr>
    <div>
        <table class="table points-table is-fullwidth">
            <thead>
            <tr>
                <th colspan="2">
                    <div class="is-flex is-flex-direction-column is-align-items-center">
                        <div class="is-flex is-flex-direction-row">
                            <div><i class="fas fa-user pr-3 is-red-team is-size-1" alt="Red team"></i></div>
                            <div><h3 class="pl-1 is-size-2 is-red-team" alt="Red team" x-text="redOperation.points + ' points'"></h3></div>
                        </div>
                        <div class="select is-small">
                            <label for="red-op-select" class="is-hidden">Select a red operation</label>
                            <select id="red-op-select" x-model="redOperation.id" x-on:change="handleOperationChange">
                                <option value="">Select a red op</option>
                                <template x-for="op in redOps" :key="op.id">
                                    <option :value="op.id" x-text="op.name + ' - ' + op.start"></option>
                                </template>
                            </select>
                        </div>
                        <label x-bind:class="redOperation.state === 'running' ? 'has-text-success' : 'has-text-warning'"
                               class="is-size-6 m-2" for="red-op-select" x-text="redOperation.state"></label>
                    </div>
                </th>
                <th colspan="2">
                    <div class="is-flex is-flex-direction-column is-align-items-center">
                        <div class="is-flex is-flex-direction-row">
                            <div><i class="fas fa-user pr-3 is-blue-team is-size-1" alt="Blue team"></i></div>
                            <div><h3 class="pl-1 is-size-2 is-blue-team" alt="Blue team" x-text="blueOperation.points + ' points'"></h3>
                            </div>
                        </div>
                        <div class="select is-small">
                            <label for="blue-op-select" class="is-hidden">Select a blue operation</label>
                            <select id="blue-op-select" x-model="blueOperation.id" x-on:change="handleOperationChange">
                                <option value="">Select a blue op</option>
                                <template x-for="op in blueOps" :key="op.id">
                                    <option :value="op.id" x-text="op.name + ' - ' + op.start"></option>
                                </template>
                            </select>
                        </div>
                        <label x-bind:class="blueOperation.state === 'running' ? 'has-text-success' : 'has-text-warning'"
                               class="is-size-6 m-2" for="blue-op-select" x-text="blueOperation.state"></label>
                    </div>
                </th>
                <td>
                    <div class="is-flex is-flex-direction-column is-align-items-center mb-3">
                        <h3>Stats</h3>
                        <table class="table">
                            <thead>
                            <tr>
                                <th></th>
                                <th><i class="fas fa-plus"></i></th>
                                <th><i class="fas fa-minus"></i></th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <th>True</th>
                                <td class="is-blue-team">100%</td>
                                <td class="is-blue-team">100%</td>
                            </tr>
                            <tr>
                                <th>False</th>
                                <td class="is-red-team">50%</td>
                                <td class="is-red-team">50%</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </td>
            </tr>
            </thead>
            <template x-if="redOperation.id.length > 0 && blueOperation.id.length > 0">
            <tbody>
                <template x-for="(red, e_index) in exchanges.red" :key="'ex-'+e_index">
                    <tr class="m-2">
                        <td class="is-flex is-flex-direction-column is-align-items-center m-3">
                            <span x-text="red.ability.name"></span>
                            <span x-text="getHumanFriendlyTimeISO8601(red.finish)"></span>
                            <span x-text="red.paw"></span>
                        </td>
                        <td class="is-size-2 is-red-team mt-1"><i class="far fa-circle"></i></td>
                        <td class="is-size-2 is-blue-team" x-text="exchanges.blue[e_index]?.points.value"></td>
                        <td class="is-vertical" x-text="exchanges.blue[e_index]?.points.reason"></td>
                    </tr>
                </template>
            </tbody>
            </template>
        </table>
    </div>
</div>

<script>
    let redOps = {{ red_ops | tojson }};
    let blueOps = {{ blue_ops | tojson }};

    function alpineGameboard() {
        return {
            gameboard: [],
            redOperation: {
                id: '',
                state: '',
                points: 0
            },
            blueOperation: {
                id: '',
                state: '',
                points: 0
            },
            access: '',
            exchanges: {
                red: [],
                blue: []
            },

            initPage() {
                // console.log('ops', this.redOps, this.blueOps);
            },
            handleOperationChange() {
                console.log('changed', this.redOperation.id, this.blueOperation.id);
                const render = (data) => {
                    console.log('render called', data);
                    this.redOperation.state = data.red_op_state;
                    this.blueOperation.state = data.blue_op_state;
                    this.redOperation.points = data.points[0];
                    this.blueOperation.points = data.points[1];
                    this.access = data.access;
                    console.log(data.exchanges, data.access, this.access)
                    if (data.exchanges[0] && data.exchanges[0].length > 1) {
                        console.log('EXCHANGES', data.exchanges[0][1])
                        this.exchanges = data.exchanges[0][1];
                    }
                };
                restRequest('POST', { red: this.redOperation.id, blue: this.blueOperation.id }, render, '/plugin/gameboard/pieces');
            },
        };
    }

    // # sourceURL=gameboard.js
</script>

<style>
    #gameboardPage .is-red-team {
        color: #BF1414;
    }
    #gameboardPage .is-blue-team {
        color: #4444D8;
    }

    #gameboardPage .points-table thead th:not(:last-child) {
        width: 40%;
    }

    #gameboardPage .points-table tr, #gameboardPage .points-table td {
        border: none;
    }

    #gameboardPage .points-table tr, #gameboardPage .points-table td {
        vertical-align: middle !important;
    }
</style>
